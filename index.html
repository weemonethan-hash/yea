<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Trusted London Clock & Timer</title>
<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin-top: 50px;
        background: #111;
        color: #eee;
    }
    .time {
        font-size: 48px;
        margin-bottom: 20px;
    }
    .timer {
        font-size: 36px;
        margin-top: 30px;
    }
    button {
        font-size: 22px;
        padding: 10px 25px;
        margin: 10px;
    }
</style>
</head>
<body>

<h1>Trusted London Clock & Timer</h1>

<div class="time" id="clock">Loading...</div>

<div class="timer" id="timer">00:00:00</div>
<button id="start">Start Timer</button>
<button id="stop">Stop Timer</button>
<button id="reset">Reset</button>

<script>
const TIME_API = "https://worldtimeapi.org/api/timezone/Europe/London";
let serverTime = null;
let lastSync = null;

// Re-sync server time
async function fetchServerTime() {
    try {
        const res = await fetch(TIME_API);
        const data = await res.json();
        serverTime = new Date(data.datetime);
        lastSync = Date.now(); // local timestamp of fetch
    } catch (e) {
        console.error("Error fetching time:", e);
    }
}

// Update displayed clock every second
async function updateClock() {
    if (!serverTime) {
        await fetchServerTime();
    }
    // Add elapsed time since last sync (based on user's timer, not system clock)
    const now = Date.now();
    const elapsed = now - lastSync;

    const current = new Date(serverTime.getTime() + elapsed);

    document.getElementById("clock").innerText =
        current.toLocaleTimeString("en-GB", { hour12: false });

    requestAnimationFrame(updateClock);
}

// TIMER (based on server time)
let timerRunning = false;
let timerStartServer = 0;
let timerSaved = 0;

async function startTimer() {
    if (!serverTime) await fetchServerTime();

    const nowLocal = Date.now();
    const elapsedSinceSync = nowLocal - lastSync;
    const nowServer = serverTime.getTime() + elapsedSinceSync;

    if (!timerRunning) {
        timerRunning = true;
        timerStartServer = nowServer - timerSaved; // continue from previous
    }
}

function stopTimer() {
    timerRunning = false;
}

function resetTimer() {
    timerSaved = 0;
    document.getElementById("timer").innerText = "00:00:00";
}

function updateTimer() {
    if (timerRunning) {
        const nowLocal = Date.now();
        const elapsedSinceSync = nowLocal - lastSync;
        const nowServer = serverTime.getTime() + elapsedSinceSync;

        const elapsed = nowServer - timerStartServer;

        const hours = Math.floor(elapsed / 3600000);
        const mins = Math.floor((elapsed % 3600000) / 60000);
        const secs = Math.floor((elapsed % 60000) / 1000);

        timerSaved = elapsed;

        document.getElementById("timer").innerText =
            `${String(hours).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
    }

    requestAnimationFrame(updateTimer);
}

// Buttons
document.getElementById("start").onclick = startTimer;
document.getElementById("stop").onclick = stopTimer;
document.getElementById("reset").onclick = resetTimer;

// Start clocks
fetchServerTime().then(() => {
    updateClock();
    updateTimer();
});
</script>

</body>
</html>
